<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/video.js@7.10.2/dist/video-js.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/video.js@7.10.2/dist/video.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <title>Video Upload</title>
</head>
<body>
    <header>
        <h1>Upload Video</h1>
        <nav class="hidden" id="nav">
            <a href="index.html" class="link" id="home">Home</a>
            <a href="" class="link" id="upload">Upload New Video</a>
            <a href="login.html" class="link" id="login">SignUp/Login</a>
          </nav>
    </header>
    <form id="uploadForm">
        <input type="text" name="title", placeholder="Please specify the name", id="title">
        <input type="text" name="tags" id="tags" placeholder="Add video tags separated by a comma">
        <input type="text" name="description" id="description" placeholder="Add video description here">
        <input type="file" name="video" id="video" placeholder="Please Select a file!">
        <button id="uploadBtn" >Submit</button>
    </form>
    <script src="upload.js"></script>
    <script>
        const BASE_URL = window.location.origin;
        document.getElementById("uploadBtn").addEventListener('click',initUpload);
        
         async function initUpload(e){
            e.preventDefault();
            const title = document.getElementById("title").value;
            const fileTags = document.getElementById("tags").value;
            const description = document.getElementById("description").value;
            const data = {"title":title,
                "tags":fileTags,
                "description":description
            }
            try {
                const response = await fetch(`${BASE_URL}/api/videos`, {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                await uploadFileInChunks(result);
            } catch (error) {
                console.error('Error while sending data:', error);
            }   
        }
        async function uploadFileInChunks(key){
            const startTime = new Date();

            const uploadKey = key.uploadKey
            // console.log('Response from server:', uploadKey);
            const file = document.getElementById('video').files[0];
            const fileName = file.name;
            const fileSize = file.size;
            const chunkSize = 1024*1024 //50MB
            const lastChunkSize = fileSize%chunkSize;
            const totalChunks = Math.floor(fileSize/chunkSize)+(lastChunkSize>0?1:0);
            console.log(`total chunks are: ${totalChunks} of file of size ${fileSize} in bytes`)
            let uploadedChunks=0;
            const fetchReqArray = [];
            let progress = 0;
            let start = 0 , end;
            for(let chunkIndex=0;chunkIndex<totalChunks;chunkIndex++){
                end = start+chunkSize;
                const chunk = file.slice(start,end);
                const formData = new FormData();
                formData.append('uploadKey',uploadKey);
                formData.append('fileName',fileName);
                formData.append('chunkIndex',chunkIndex);
                formData.append('totalChunks',totalChunks);
                formData.append('chunk',chunk);
              
                const req = fetch(`${BASE_URL}/api/videos/upload`,{
                    method:'POST',
                    body:formData
                }).then(response=>{
                    if (!response.ok) {
                    throw new Error(`Chunk ${chunkIndex} upload failed with status: ${response.status}`);
                    }
                    uploadedChunks++;
                    progress = Math.floor(uploadedChunks/totalChunks*100);
                    console.log(`uploaded chunk number ${chunkIndex} TOTALCHUNKS: ${totalChunks} UPLOADEDCHUNKS: ${uploadedChunks} PROGRESS: ${progress}`)
                    return response.json();
                });
                fetchReqArray.push(req);
                start = end;
            }
            if(lastChunkSize>0){
                end = start+lastChunkSize
                const chunk = file.slice(start,end);
                const formData = new FormData();
                formData.append('uploadKey',uploadKey);
                formData.append('fileName',fileName);
                formData.append('chunkIndex',totalChunks-1);
                formData.append('totalChunks',totalChunks);
                formData.append('chunk',chunk);
    
                const req = fetch(`${BASE_URL}/api/videos/upload`,{
                    method:'POST',
                    body:formData
                }).then(response=>{
                    if (!response.ok) {
                    throw new Error(`Chunk ${chunkIndex} upload failed with status: ${response.status}`);
                    }
                    uploadedChunks++;
                    progress = Math.floor(uploadedChunks/totalChunks*100);
                    console.log(`uploaded chunk number ${chunkIndex} TOTALCHUNKS: ${totalChunks} UPLOADEDCHUNKS: ${uploadedChunks} PROGRESS: ${progress}`)
                    return response.json();
                });
                fetchReqArray.push(req);
            }
            try {
                const results = await Promise.allSettled(fetchReqArray);
                const successfulResponses = results
                    .filter(result => result.status === 'fulfilled' && result.value !== null)
                    .map(result => result.value);

                    console.log('Successfully uploaded chunks:', successfulResponses);
                    if(successfulResponses.length == totalChunks){
                        try {
                        const response = await fetch(`${BASE_URL}/api/videos/completeUpload`, {
                        method: "POST",
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({'uploadID':uploadKey,
                            'fileName':fileName
                        })
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const result = await response.json();
                        
                        } catch (error) {
                            console.error('Error while sending data:', error);
                        } 
                    }
                const endTime = new Date();
                const elapsedTime = (endTime-startTime)/1000
                
                console.log(`Upload process completed in ${elapsedTime} seconds`);
                window.location.href = '/index.html';

            } catch (error) {
                console.error('Error during chunk uploads:', error);
            }
        }

    </script>

    
</body>
</html>